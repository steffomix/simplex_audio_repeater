Schritt 1:
Ich möchte einen einfachen Simplex Repeater mit python und python gui erstellen. Er soll ab einem einstellbaren Eingangspegel anfangen audio von einer einstellbaren Quelle für eine einstellbare Zeit in sekunden Audio aufzeichnen und dann sofort wieder abspielen. wärend des abspielens soll nicht aufgenommen werden. Es soll nichts gespeichert werden.


Schritt 2:
Das Programm tut genau was es soll. Es müssen jedoch einige Anpassungen gemacht werden um die Funktionalität zu optimieren.
 
Die "Einstellbare Aufnahmezeit" soll die "Einstellbare maximale Aufnahmezeit" werden. Die Aufnahme soll abgebrochen werden wenn der Eingangspegel einen einstellbaren Abbruch-Pegel für eine einstellbare Zeit in Sekunden unterschritten wird. Dieser Abbruch-Pegel darf nicht höher sein als der maximale Eingagspegel. Der Schieberegler des Abbruch-Pegels darf nicht über den Wert des maximalen Eingangspegels hinaus geschoben werden können und dann einfach blockieren. Sollte das blockieren nicht möglich sein, soll sich der Maximalwert des Abbruch-Pegelschiebers entsprechend automatisch anpassen. 

Sollte der maximale Eingangspegel unter den aktuellen Abbruch-Pegel geschoben werden, soll sich dieser mitschieben damit gewährleistet ist, dass der Abbruch-Pegel stets unterhalb des maximalen Eingangspegel bleibt.

Schritt 3:
Das funktioniert perfekt! Nun noch eine optische Verbesserung, sofern das möglich ist. Die Zahl des Aktuellen Pegels soll duch einen grauen Balken ersetzt werden, der unterhalb von "Aktueller Pegel" steht und über die ganze Breite geht und dessen maximum gleich dem maximimalen einstellbaren Eingangspegel sein soll. Außerdem soll ein vertikaler grünen Balken integriert sein, der den aktuell eingestellten Eingangspegel darstellt und ein roter Balken, der den aktuellen Abbruchpegel darstellt.

Außerdem soll der "Aufnahme läuft..." Balken ähnlich einer Füllstandsanzeige bei der Aufnahme wachsen und beim Abspielen wieder Schrumpfen.

Schritt 4:
Das Programm funktioniert einwandfrei und die optischen Anpassungen sind super! Der Geräuschpegel ist jedoch etwas zu flatterhaft. Kannst du bitte einen einstellbaren Glättungsfaktor für den Eingangspegel hinzufügen? Der Glättungsfaktor soll als gleitender Durchschnitt über die letzten n Messwerte berechnet werden, wobei n der einstellbare Glättungsfaktor ist. Ein höherer Wert für n führt zu einer stärkeren Glättung des Pegels. Der Glättungsfaktor soll als zusätzlicher Schieberegler in der GUI hinzugefügt werden, mit einem Bereich von 1 bis 1000 millisekunden. Standardmäßig soll der Glättungsfaktor auf 50ms gesetzt sein. Dieser Schieberegler sollte zwischen dem Schieberegler für den Abbruch-Pegel und der Anzeige für den aktuellen Pegel platziert werden.

Nach dem Abspielen der Aufnahme kommt es vor, dass das Signal gewissermaßen nachhallt und eine Aufnahme auslöst. Daher soll eine eindstellbare "Totzeit" nach dem Abspielen hinzugefügt werden, während der keine Aufnahme gestartet werden kann. Die Totzeit soll in Sekunden einstellbar sein und standardmäßig auf 2 Sekunden gesetzt sein.

Schritt 5:
Es hat sich herausgestellt, dass eine einfache Dämpfung nicht ausreicht. Der Ansteigender und abfallender Pegel soll jeweils mit einem einstellbaren Anstiegs- und Abfallverhalten versehen werden. Der Anstiegswert soll in Dezibel pro Sekunde (dB/s) und der Abfallwert ebenfalls in Dezibel pro Sekunde (dB/s) einstellbar sein. Standardmäßig soll der Anstiegswert auf 10 dB/s und der Abfallwert auf 15 dB/s gesetzt sein.

Die Audio Eingangs- und Ausgangsquelle auf Default Systemquelle bzw. Systemausgabe gesetzt werden, wenn keine spezifische Quelle ausgewählt wurde.

Die eingstellten Werte sollen in einer lokalen Konfigurationsdatei gespeichert und beim start des Programms geladen werden.

Schritt 6:
Die Glättung kann entfernt werden, da sie nicht die gewünschte Wirkung erzielt

Schritt 7:
Die DB Anstiegs- und Abfalldämpfung, die die einfache Dämpfung ersetzen sollten scheinen wirkungslos oder fehlerhaft zu sein. Kannst du den Fehler finden und beheben? Außerdem sollten die Regler bis auf 0 (aus) gehen.

Schritt 8:
Ich sehe, da hat es von meiner Seite aus eine Verwechslung gegeben. Die Dämpfungsfunktionen sollen sich den Eingangspegel beziehen, der in der Pegelanzeige angezeigt wird. Eine Angabe oder gar Berechnung in dB/s ist hier nicht notwendig. Die Dämpfung soll erkennen ob der Eingangspegel ansteigt oder abfällt und die Regler sollen sollen diesen Anstieg oder Abfall separat dämpfen. Ein höherer Reglerswert der Anstiegsdämpfung soll dazu führen, dass der angezeigte Pegel langsamer ansteigt wenn der Eingangspegel steigt. Ein höherer Reglerwert der Abfalldämpfung soll dazu führen, dass der angezeigte Pegel langsamer abfällt wenn der Eingangspegel fällt. Die Dämpfungswerte sollen in Millisekunden angegeben werden, also wie lange es dauert bis der angezeigte Pegel den tatsächlichen Eingangspegel erreicht hat. Standardmäßig soll die Anstiegsdämpfung auf 0ms und die Abfalldämpfung auf 100ms gesetzt sein. Der gedämpfte Pegel soll weiterhin für die Aufnahme-Triggerung verwendet werden.

Schritt 9:
Es scheint also würden zum starten und beenden der Aufnahme nicht der gedämpfte Eingangspegel verwendet werden, sondern der rohe Eingangspegel. Bitte behebe das so, dass der gedämpfte Pegel für die Aufnahme-Triggerung verwendet wird.

Schritt 10:
Das speichern der Einstellungen in der lokalen Konfigurationsdatei "~/.simplex_repeater_config.json" funktioniert nicht richtig. Bitte behebe das so, dass alle einstellbaren Werte korrekt gespeichert und geladen werden.

Schritt 11:
Wenn der Startpegel nach dem Start des Programms noch nicht bewegt wurde, lässt sich der Abbruchpegel über den Startwert hinaus schieben. Möglicherweise fehlt ein Initialisierungswert. Bitte behebe das.

Schritt 12:
Dadurch dass die Eingangs- und Ausgangsquellen nun permanent sind, muss die aktelle Quelle bei einer Änderung automatisch getrennt und die neue Quelle verbunden werden. Bitte füge diese Funktionalität hinzu.

Schritt 13:
Technisch bedingt ist es erforderlich, dass die Aufnahme lauter abgespielt wird als sie aufgenommen wurde, um eine gute Wiedergabequalität zu gewährleisten. Bitte füge einen einstellbaren Verstärkungsfaktor hinzu, der die Lautstärke der Wiedergabe im Verhältnis zur Aufnahmepegel anpasst. Der Verstärkungsfaktor soll in Dezibel (dB) angegeben werden können, mit einem Bereich von -20 dB bis +20 dB und einem Standardwert von 0 dB.

Schritt 14 (Frage):
Ich habe ein President George II und bei der Verwendung des Simplex Repeaters kommt es mit zunehmender Lautstärke des Funkgeräts beim Funkgerät zu einer Art Aufnahmen- abspielen Schleife. Die Schleife kann nur durch herunter drehen der Lautstärke des Funkgeräts oder ziehen des Steckers vom externen Lautsprecherausgang, der am Mikrofoneingang des Simplex Repeaters angeschlossen ist, unterbrochen werden. Hast du eine Idee woran das liegen könnte und wie ich das Problem beheben kann?

Schritt 15: 
Ich glaube den Fehler gefunden zu haben. Der Simplex Repeater ist nun so programmiert, dass Aufnahme und Wiedergabe permanent aktiv sind, das war keine gute Idee. Offenbar scheint es von Recher- oder Funkgerätseite Knackgeräusche beim Umschalten zu geben, denn die Schleife beginnt wenn die Lautstärke des Funkgeräts zu hoch ist und nach dem Abspielen der Aufnahme. Bitte ändere das Programm so, dass die Audio Eingangs- und Ausgangsquellen nur während der Aufnahme bzw. Wiedergabe verbunden sind und bei der Totzeit nichts verbunden ist. 

Schritt 16:
Das Programm funktioniert jetzt einwandfrei und die Aufnahme-Wiedergabe Schleife ist verschwunden! Gelöst wurde das Problem durch eine elektrische Entkopplung des Lautsprecherausgangs. Es wäre zwar schön gewesen wenn es ohne diese zusätzliche Bauteil funktioniert hätte, aber alle Versuche haben gezeigt, dass es sich nicht mit Software ersetzen lässt. Vielen Dank für deine Tipps und deine Hilfe!

Ich möchte das Programm nun erweitern. Dazu ist es nötig das GUI in zwei Spalten aufzuteilen. In der linken Spalte sollen alle Einstellungen für den Eingangsbereich sein und in der rechten Spalte alle Einstellungen für den Ausgangsbereich. Es soll weiterhin so programmiert sein wie im Quellcode zum Beispiel in diesen Zeilen zu sehen ist:

65: row=0
77: row+=1
97: row+=1

Dadurch lässt sich die Reihenfolge der Einstellungen leichter ändern.


Der Ausgangsbereich soll um einen mehrband Equalizer erweitert werden, der die Frequenzbereiche 60Hz, 230Hz, 910Hz, 3.6kHz und 14kHz abdeckt. Jeder Frequenzbereich soll einen eigenen Schieberegler für die Verstärkung in Dezibel (dB) haben, mit einem Bereich von -12 dB bis +12 dB und einem Standardwert von 0 dB. Der Equalizer soll die Audiodaten in Echtzeit während der Wiedergabe verarbeiten. Hier ist der Link zu einem Beispielprojekt, das als Grundlage für die Implementierung des Equalizers dienen kann: https://github.com/mayank12gt/Audio-Equalizer

Außerdem soll der Repeater um eine Douplex Funktion erweitert werden. Der Repeater soll dann gleichzeitig aufnehmen und wiedergeben können, ohne dass die Aufnahme durch die Wiedergabe unterbrochen wird. Der Equalizer soll sowohl auf die Simplex- als auch auf die Duplex-Funktion angewendet werden können, aber nur das abgespielte Signal beeinflussen.

Der Knopf zum umschalten zwischen Simplex und Duplex soll in der Mitte über den beiden Spalten platziert werden. Die Überschrift des Programms soll ebenfalls in die Mitte über den Umschaltknopf platziert werden und sich je nach Modus in "Simplex Repeater" oder "Duplex Repeater" ändern.

Schritt 17:
Das Programm und der Equalizer funktioniert bis auf die Douplex Aufnahme oder Wiedergabe einwandfrei! Die Wiedergabe beginnt erst nach der eingestellten Simplex Aufnahmezeit, sollte aber sofort beginnen. Sobald die Wiedergabe dann beginnt, stottert sie jedoch stark. Bitte behebe das so, dass die Wiedergabe sofort nach dem Start der Aufnahme beginnt und flüssig wiedergegeben wird. 
Eine 8 Sekunden lange Aufnahme der stotternden Wiedergabe findest du in der Datei "test-record-440hz.flac".

Zusätzlich soll eine einstellbare Verzögerungszeit von bis zu 1 Sekunde für die Wiedergabe hinzugefügt werden, die in Millisekunden angegeben wird, um Rückkopplungen zu unterdrücken. Start- und Stoppegel sollen in der Duplex Funktion ignoriert werden, da die Aufnahme permanent läuft. 

Schritt 18:
Die Duplex Funktion funktioniert jetzt einwandfrei! Es gibt jedoch noch zwei Probleme. Erstens soll die Verzögerungszeit die Wiedergabe zwar verzögern, aber so dass sie insgesamt asynchron zur Aufnahme bleibt um Rückkopplungen zu vermeiden. Derzeit scheint die Verzögerung die Wiedergabe nur beim Start zu verzögern, aber danach sind Aufnahme und Wiedergabe wieder synchron. Bitte behebe das.

Zweitens gibt es Performance Probleme durch die hohe Abtastrate von derzeit  
self.RATE = 44100 
wie in Zeile 50 des Codes festgelegt.
Mit einer Rate von 22000 läuft es ohne Equalizer flüssig, aber mit Equalizer muss ich auf 8000 runter gehen um flüssige Wiedergabe zu haben. Mehrere Anpassungen müssen gemacht werden um mit diesem Problem fertig zu werden.

Ein Pulldown Menü soll hinzugefügt werden, mit dem die Abtastrate ausgewählt werden kann. Mögliche Werte sind 8000, 16000, 22000, 32000 und 44100 Hz. Standardmäßig soll die Abtastrate auf 22000 Hz gesetzt sein.
Der Equalizer soll optional deaktiviert werden können, um die Performance zu verbessern. Dazu soll ein Kontrollkästchen in der Ausgangsspalte hinzugefügt werden mit der Bezeichnung "Equalizer aktivieren", das standardmäßig aktiviert ist.

Es einen Hinweis in der GUI geben, dass höhere Abtastraten die Performance beeinträchtigen können, insbesondere wenn der Equalizer aktiviert ist, was eine flüssige Wiedergabe erschwert.

Untersuche ob der Code optimiert werden kann, um die Performance bei höheren Abtastraten zu verbessern, insbesondere wenn der Equalizer aktiviert ist.

Schritt 19:
Kann es sein dass die Aktualisierung des Pegelbalkens oder Aktualisierungen der GUI generell die Performance der Audioverarbeitung beeinträchtigt? Wenn ja, optimiere die Pegelbalkenaktualisierung oder die GUI generell bitte so dass sie die Audioverarbeitung nicht mehr oder möglichst wenig beeinträchtigt.


Schritt 20: Grundsätzlich funktioniert alles einwandfrei. Die GUI wird in nicht mehr bei jedem Loop aktualisiert. Die performance hat sich jedoch eher verschlechtert und ich kann nicht erkennen woran das liegt. Kannst du den Code bitte auf Performance optimieren, insbesondere im Hinblick auf die Audioverarbeitung und die GUI-Aktualisierungen?


Schritt 21: Ich habe einen log erstellt, der vielleicht hilft das Problem zu finden:
Repeater Log Start.
duplex_playback_buffer 1 removed, length now:   1,       playback time: 2.86102294921875e-06
duplex_playback_buffer 1 added, length now:   2,         record time: 0.08020830154418945
duplex_playback_buffer 1 removed, length now:   1,       playback time: 7.152557373046875e-06
duplex_playback_buffer 1 added, length now:   2,         record time: 0.0855858325958252
duplex_playback_buffer 1 removed, length now:   1,       playback time: 4.76837158203125e-06
duplex_playback_buffer 1 added, length now:   2,         record time: 0.00021529197692871094
duplex_playback_buffer 1 added, length now:   3,         record time: 0.08573412895202637
duplex_playback_buffer 1 removed, length now:   2,       playback time: 8.106231689453125e-06
duplex_playback_buffer 1 added, length now:   3,         record time: 8.392333984375e-05
duplex_playback_buffer 1 added, length now:   4,         record time: 0.0863029956817627
duplex_playback_buffer 1 removed, length now:   3,       playback time: 5.7220458984375e-06
duplex_playback_buffer 1 added, length now:   4,         record time: 0.00019240379333496094
duplex_playback_buffer 1 added, length now:   5,         record time: 0.08603787422180176
duplex_playback_buffer 1 removed, length now:   4,       playback time: 5.9604644775390625e-06
duplex_playback_buffer 1 removed, length now:   3,       playback time: 2.6226043701171875e-06
duplex_playback_buffer 1 removed, length now:   2,       playback time: 1.0728836059570312e-05
duplex_playback_buffer 1 added, length now:   3,         record time: 0.0511784553527832
duplex_playback_buffer 1 added, length now:   4,         record time: 1.621246337890625e-05
duplex_playback_buffer 1 added, length now:   5,         record time: 0.07674407958984375
duplex_playback_buffer 1 removed, length now:   4,       playback time: 5.4836273193359375e-06
duplex_playback_buffer 1 added, length now:   5,         record time: 0.08611845970153809
duplex_playback_buffer 1 removed, length now:   4,       playback time: 7.152557373046875e-06
duplex_playback_buffer 1 added, length now:   5,         record time: 0.0003414154052734375
duplex_playback_buffer 1 added, length now:   6,         record time: 0.08580303192138672
duplex_playback_buffer 1 removed, length now:   5,       playback time: 6.4373016357421875e-06
duplex_playback_buffer 1 added, length now:   6,         record time: 0.00020313262939453125
duplex_playback_buffer 1 added, length now:   7,         record time: 0.08585667610168457
duplex_playback_buffer 1 removed, length now:   6,       playback time: 5.0067901611328125e-06
duplex_playback_buffer 1 removed, length now:   5,       playback time: 2.6226043701171875e-06
duplex_playback_buffer 1 removed, length now:   4,       playback time: 1.1205673217773438e-05
duplex_playback_buffer 1 added, length now:   5,         record time: 0.04778933525085449
duplex_playback_buffer 1 added, length now:   6,         record time: 1.239776611328125e-05
duplex_playback_buffer 1 added, length now:   7,         record time: 0.0804588794708252
duplex_playback_buffer 1 removed, length now:   6,       playback time: 5.7220458984375e-06
duplex_playback_buffer 1 added, length now:   7,         record time: 0.08583664894104004
duplex_playback_buffer 1 removed, length now:   6,       playback time: 5.9604644775390625e-06
duplex_playback_buffer 1 added, length now:   7,         record time: 0.0002200603485107422
duplex_playback_buffer 1 removed, length now:   6,       playback time: 3.337860107421875e-06
duplex_playback_buffer 1 added, length now:   7,         record time: 0.08564329147338867
duplex_playback_buffer 1 removed, length now:   6,       playback time: 4.76837158203125e-06
duplex_playback_buffer 1 added, length now:   7,         record time: 0.0001232624053955078
duplex_playback_buffer 1 added, length now:   8,         record time: 0.0855402946472168
duplex_playback_buffer 1 removed, length now:   7,       playback time: 3.337860107421875e-06
duplex_playback_buffer 1 removed, length now:   6,       playback time: 1.1920928955078125e-06
duplex_playback_buffer 1 added, length now:   7,         record time: 1.2636184692382812e-05
duplex_playback_buffer 1 added, length now:   8,         record time: 0.08533906936645508
duplex_playback_buffer 1 removed, length now:   7,       playback time: 5.245208740234375e-06
duplex_playback_buffer 1 added, length now:   8,         record time: 0.00011324882507324219
duplex_playback_buffer 1 added, length now:   9,         record time: 0.08566713333129883
duplex_playback_buffer 1 removed, length now:   8,       playback time: 5.245208740234375e-06
duplex_playback_buffer 1 added, length now:   9,         record time: 0.0002505779266357422
duplex_playback_buffer 1 added, length now:   10,        record time: 0.0854637622833252
duplex_playback_buffer 1 removed, length now:   9,       playback time: 5.4836273193359375e-06
duplex_playback_buffer 1 added, length now:   10,        record time: 0.08551287651062012
duplex_playback_buffer 1 removed, length now:   9,       playback time: 5.7220458984375e-06
duplex_playback_buffer 1 added, length now:   10,        record time: 2.3603439331054688e-05
duplex_playback_buffer 1 removed, length now:   9,       playback time: 1.0728836059570312e-05
duplex_playback_buffer 1 added, length now:   10,        record time: 0.04278445243835449
Repeater Log Ende.

Repeater config:
{
  "start_threshold": 1000,
  "stop_threshold": 100,
  "rise_time": 0.0,
  "fall_time": 100.0,
  "record_time": 30.0,
  "stop_time": 0.5,
  "dead_time": 2.0,
  "gain": 0.0,
  "playback_delay": 0,
  "equalizer": {
    "60": 0.0,
    "230": 0.0,
    "910": 0.0,
    "3600": 0.0,
    "14000": 0.0
  },
  "equalizer_enabled": false,
  "sample_rate": 22000,
  "duplex_mode": true,
  "input_device": "8: default",
  "output_device": "8: default"
}

Schritt 22:
Die Zeitmessungen dienten lediglich zum messen der Performance. Ich habe sie herausgenommen um nicht zu verwirren. Der Buffer steigt immer noch an. Vielleicht sollte man den nicht nach Zeit leeren, sondern nach nur soweit um die eingestellte Verzögerungszeit zu erfüllen.

Log Start:
duplex_playback_buffer 1 removed, length now:   1
duplex_playback_buffer 1 added, length now:   2
duplex_playback_buffer 1 removed, length now:   1
duplex_playback_buffer 1 added, length now:   2
duplex_playback_buffer 1 removed, length now:   1
duplex_playback_buffer 1 added, length now:   2
duplex_playback_buffer 1 added, length now:   3
duplex_playback_buffer 1 removed, length now:   2
duplex_playback_buffer 1 added, length now:   3
duplex_playback_buffer 1 added, length now:   4
duplex_playback_buffer 1 added, length now:   5
duplex_playback_buffer 1 removed, length now:   4
duplex_playback_buffer 1 added, length now:   5
duplex_playback_buffer 1 removed, length now:   4
duplex_playback_buffer 1 added, length now:   5
duplex_playback_buffer 1 removed, length now:   4
duplex_playback_buffer 1 added, length now:   5
duplex_playback_buffer 1 added, length now:   6
duplex_playback_buffer 1 removed, length now:   5
duplex_playback_buffer 1 added, length now:   6
duplex_playback_buffer 1 removed, length now:   5
duplex_playback_buffer 1 added, length now:   6
duplex_playback_buffer 1 added, length now:   7
duplex_playback_buffer 1 added, length now:   8
duplex_playback_buffer 1 added, length now:   9
duplex_playback_buffer 1 removed, length now:   8
duplex_playback_buffer 1 added, length now:   9
duplex_playback_buffer 1 removed, length now:   8
duplex_playback_buffer 1 added, length now:   9
duplex_playback_buffer 1 removed, length now:   8
duplex_playback_buffer 1 added, length now:   9
duplex_playback_buffer 1 removed, length now:   8
duplex_playback_buffer 1 added, length now:   9
duplex_playback_buffer 1 added, length now:   10
duplex_playback_buffer 1 removed, length now:   9
duplex_playback_buffer 1 added, length now:   10
Log Ende.

Schritt 23:
Mit ein paar Handgriffen konnte ich die Performance Probleme im Duplex Modus deutlich reduzieren. Jetzt erst mal wieder zurück zum Simplex Modus. Der Spielt keinen Ton ab und braucht keine Performance Optimierung. Der Levelbalken muss im Simplex Modus auch nicht aktualisiert werden. Bitte behebe das.